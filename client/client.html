<!DOCTYPE html>
<html lang="en">

<head>
    <title>430 TWR Project 1</title>
    <link rel="stylesheet" type="text/css" href="style.css">
    <script>
        const handleContent = async (response, parseResponse) => {
            // Grab content element
            const content = document.querySelector('#content');

            // Display status code
            switch (response.status) {
                case 200:
                    content.innerHTML = '<h1><b>Success</b></h1>';
                    break;
                case 201:
                    content.innerHTML = '<h1><b>Created</b></h1>';
                    break;
                case 204:
                    content.innerHTML = '<h1><b>Updated (No Content)</b></h1>';
                    break;
                case 400:
                    content.innerHTML = '<h1><b>Bad Request</b></h1>';
                    break;
                case 404:
                    content.innerHTML = '<h1><b>Not Found</b></h1>';
                    break;
                default:
                    content.innerHTML = '<h1><b>Code Not Yet Implimented</b></h1>';
                    break;
            }

            if (parseResponse !== 'head') {
                try {
                    let responseObj = await response.json();
                    let jsonString = JSON.stringify(responseObj);

                    // If a message exists, display it, otherwise display json string
                    if (responseObj.message) {
                        content.innerHTML += `<p>${responseObj.message}</p>`;
                    }
                    else {
                        content.innerHTML += `<p>${jsonString}</p>`;
                    }

                } catch (error) {

                }
            }
        };

        const sendGetRequest = async (form, params) => {
            // unsure if needed, could prob hardcode
            const url = form.getAttribute('action');
            const method = form.querySelector('.methodField').value;

            let newUrl = url;

            // if there are params, add the starter
            if (params.length > 0) {
                newUrl += `?`;
            }

            for (let i = 0; i < params.length; i++) {
                // if this isn't the first item, add an &
                if (i > 0) {
                    newUrl += '&';
                }

                // if the parameter is a string, format it properly
                let paramValue = params[i].field.value;
                if (typeof paramValue === 'string') {
                    paramValue = paramValue.replace(/\s/g, '').toLowerCase();
                }

                // add query to url
                newUrl += `${params[i].name}=${paramValue}`;
            }

            const response = await fetch(newUrl, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                },
            });

            handleContent(response, method);
        };

        const sendPostRequest = async (form, params) => {
            const url = form.getAttribute('action');
            const method = form.getAttribute('method');
            const dataType = form.querySelector('.dataType').value;

            // default to url encoded
            let data = '';
            for (let i = 0; i < params.length; i++) {
                // if this isn't the first item, add an &
                if (i > 0) {
                    data += '&';
                }

                // if the parameter is a string, format it properly
                let paramValue = params[i].field.value;
                if (typeof paramValue === 'string') {
                    paramValue = paramValue.replace(/\s/g, '');
                }

                // add query to url
                data += `${params[i].name}=${paramValue}`;
            }

            // if data is json format it
            if (dataType === 'application/json') {
                data = {};
                for(let i = 0; i < params.length; i++) {
                    data[params[i].name] = params[i].field.value;
                }
                data = JSON.stringify(data);
            }

            console.log(dataType);

            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': dataType,
                    'Content-Length' : data.length,
                    'Accept': 'application/json',
                },
                body: data,
            });

            handleContent(response, method);
        }

        const setup = () => {
            // get request forms
            const titleAuthorForm = document.querySelector('#titleAuthorForm');
            const genreForm = document.querySelector('#genreForm');
            const yearForm = document.querySelector('#yearForm');
            const getAllForm = document.querySelector('#getAllForm');

            // post request forms
            const addBookForm = document.querySelector('#addBookForm');
            const addRatingForm = document.querySelector('#ratingForm');

            // get request methods
            const searchTitleAuthor = (e) => {
                e.preventDefault();

                // create parameter list
                const paramList = [];
                paramList[0] = { name: 'title', field: titleAuthorForm.querySelector('.titleField') };
                paramList[1] = { name: 'author', field: titleAuthorForm.querySelector('.authorField') };

                sendGetRequest(titleAuthorForm, paramList);
                return false;
            }

            const searchGenre = (e) => {
                e.preventDefault();

                const paramList = [];
                paramList[0] = { name: 'genre', field: genreForm.querySelector('.genreField') }

                sendGetRequest(genreForm, paramList);
                return false;
            }

            const searchYear = (e) => {
                e.preventDefault();

                const paramList = [];
                paramList[0] = { name: 'yearMin', field: yearForm.querySelector('.yearMinField') };
                paramList[1] = { name: 'yearMax', field: yearForm.querySelector('.yearMaxField') };

                sendGetRequest(yearForm, paramList);
                return false;
            }

            const getAll = (e) => {
                e.preventDefault();
                const paramList = [];
                sendGetRequest(getAllForm, paramList);
                return false;
            }

            // post request methods
            const addBook = (e) => {
                e.preventDefault();

                const paramList = [];
                paramList[0] = { name: 'title', field: addBookForm.querySelector('.titleField') };
                paramList[1] = { name: 'author', field: addBookForm.querySelector('.authorField') };
                paramList[2] = { name: 'year', field: addBookForm.querySelector('.yearField') };
                paramList[3] = { name: 'genre', field: addBookForm.querySelector('.genreField') };

                sendPostRequest(addBookForm, paramList);
                return false;
            }

            const addRating = (e) => {
                e.preventDefault();
                const paramList = [];
                paramList[0] = { name: 'title', field: addRatingForm.querySelector('.titleField') };
                paramList[1] = { name: 'rating', field: addRatingForm.querySelector('.ratingField') };

                sendPostRequest(addRatingForm, paramList);
                return false;
            }

            // assigning events
            titleAuthorForm.addEventListener('submit', searchTitleAuthor);
            genreForm.addEventListener('submit', searchGenre);
            yearForm.addEventListener('submit', searchYear);
            getAllForm.addEventListener('submit', getAll);
            addBookForm.addEventListener('submit', addBook);
            addRatingForm.addEventListener('submit', addRating);
        }

        const init = () => {
            setup();
        };

        window.onload = init;
    </script>
</head>

<body>
    <h1>Client Page</h1>

    <h1>/getByTitleAuthor (GET)</h1>
    <form id="titleAuthorForm" action="/getByTitleAuthor" method="get">
        <label for="title">Title: </label>
        <input class="titleField" type="text" name="title" />
        <label for="author">Author: </label>
        <input class="authorField" type="text" name="author" />
        <select class="methodField" name="method">
            <option value="get">GET</option>
            <option value="head">HEAD</option>
        </select>
        <input type="submit" value="Search">
    </form>
    <hr>

    <h1>/getByGenre (GET)</h1>
    <form id="genreForm" action="/getByGenre" method="get">
        <label for="genre">Genre: </label>
        <input class="genreField" type="text" name="genre">
        <select class="methodField" name="method">
            <option value="get">GET</option>
            <option value="head">HEAD</option>
        </select>
        <input type="submit" value="Search">
    </form>
    <hr>

    <!-- Got some help for inline js for updating the label from here: https://stackoverflow.com/questions/15195449/html5-type-range-showing-label -->
    <h1>/getByYear (GET)</h1>
    <form id="yearForm" action="/getByYear" method="get">
        <label id="yearMinLabel" for="yearMin">Lower bound (Gregorian): -1700</label>
        <input class="yearMinField" type="range" name="yearMin" min="-1700" max="2000" value="-1700" step="100"
            oninput="document.querySelector('#yearMinLabel').innerHTML = `Lower bound (Gregorian Calender): ${this.value}`">
        <label id="yearMaxLabel" for="yearMax">Upper bound (Gregorian): 2000</label>
        <input class="yearMaxField" type="range" name="yearMax" min="-1700" max="2000" value="2000" step="100"
            oninput="document.querySelector('#yearMaxLabel').innerHTML = `Upper bound (Gregorian Calender): ${this.value}`">
        <select class="methodField" name="method">
            <option value="get">GET</option>
            <option value="head">HEAD</option>
        </select>
        <input type="submit" value="Search">
    </form>
    <hr>

    <h1>/getAllEntries (GET)</h1>
    <form id="getAllForm" action="/getAllEntries" method="get">
        <select class="methodField" name="method">
            <option value="get">GET</option>
            <option value="head">HEAD</option>
        </select>
        <input type="submit" value="Search">
    </form>
    <hr>

    <h1>/addBook (POST)</h1>
    <form id="addBookForm" action="/addBook" method="post">
        <label for="title">Title: </label>
        <input class="titleField" type="text" name="title" />
        <label for="author">Author: </label>
        <input class="authorField" type="text" name="author" />
        <label for="year">Year (Gregorian): </label>
        <input class="yearField" type="text" name="year" />
        <label for="genre">Genre: </label>
        <input class="genreField" type="text" name="genre" />
        <select class="dataType" name="dataType">
            <option value="application/x-www-form-urlencoded">URL Encoded</option>
            <option value="application/json">JSON</option>
        </select>
        <input type="submit" value="Submit">
    </form>
    <hr>

    <h1>/addRating (POST)</h1>
    <form id="ratingForm" action="/addRating" method="post">
        <label for="title">Title: </label>
        <input class="titleField" type="text" name="title" />
        <label id="ratingLabel" for="rating">Rating: 3/5</label>
        <input class="ratingField" type="range" name="rating" min="0" max="5" value="3" step="1"
            oninput="document.querySelector('#ratingLabel').innerHTML = `Rating: ${this.value}/5`">
        <select class="dataType" name="dataType">
            <option value="application/x-www-form-urlencoded">URL Encoded</option>
            <option value="application/json">JSON</option>
        </select>
        <input type="submit" value="Submit">
    </form>
    <hr>

    <section id="content">
    </section>
</body>

</html>